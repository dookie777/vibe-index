<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>YouTube VIBE Index Analyzer</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.9.2/dist/html2pdf.bundle.min.js"></script>

<style>
body { background-color: #000000; color: #fff; font-family: Arial, sans-serif; margin: 0; padding: 0; }
.container { padding: 20px; max-width: 1200px; margin: auto; }
h1 { font-size: 2rem; text-align: center; color: #ffa500; }

.tabs { display: flex; justify-content: center; margin-bottom: 20px; }
.tab {
  padding: 10px 20px;
  cursor: pointer;
  background-color: #222222;
  color: #AAAAAA;
  margin: 0 5px;
  border-radius: 10px;
  font-weight: bold;
  font-size: 0.9rem;
  box-shadow: none;
}
.tab.active {
  background-color: #333333;
  color: #FFFFFF;
}

.input-area { text-align: center; margin-bottom: 20px; }
.input-area input { padding: 10px; margin: 5px; width: 300px; border-radius: 5px; border: none; }
.input-area button {
  padding: 10px 20px;
  margin-left: 10px;
  border-radius: 5px;
  border: none;
  background-color: #ffa500;
  color: #000;
  cursor: pointer;
  font-weight: bold;
  box-shadow: none;
}

.mode-selector {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  margin-top: 10px;
  font-size: 0.8rem;
}
.mode-selector label {
  font-weight: normal;
}

.result-card {
  background-color: #1e1e1e;
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 0 10px rgba(255,165,0,0.2);
  width: 360px;
  line-height: 1.3;
  text-align: left;
}

.channel-info { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
.channel-info img { width: 80px; height: 80px; border-radius: 50%; }

.channel-details { font-size: 0.9rem; line-height: 1.4; }
.channel-details ul { padding-left: 20px; margin: 5px 0 0 0; }
.channel-details li { list-style-type: disc; margin: 3px 0; }

.metric { font-size: 0.8rem; font-weight: bold; margin: 10px 0; }
.metric span.label { color: #ffffff; }
.metric span.label.vibe-label { color: #ffff00; }
.metric span.value { font-size: 1.3rem; color: #ffa500; }
.metric span.value.vibe-index { font-size: 1.6rem; color: #ffa500; }
.metric span.value.vibe-index small { font-size: 0.8rem; color: #ffffff; }

.sub-details {
  font-size: 0.8rem;
  font-weight: normal;
  line-height: 1.3;
}

button:hover { opacity: 0.8; }

table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
th, td { padding: 6px; border: 1px solid #333; text-align: center; }
th { background-color: #333; color: #ffa500; }

.error { color: red; text-align: center; margin-top: 10px; }

#compareResult { display: flex; flex-wrap: nowrap; gap: 20px; overflow-x: auto; }

footer {
  padding: 10px 0;
  border-top: 1px solid #333;
  font-size: 0.8rem;
  color: #888;
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background-color: #000000;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.mode-selector {
  margin-bottom: 25px; /* ë²„íŠ¼ê³¼ ê²°ê³¼ ì¹´ë“œ ê°„ê²© í™•ë³´ */
}

#compareResult {
  margin-top: 20px; /* ë©€í‹° ì±„ë„ ê²°ê³¼ ì¹´ë“œ ìœ„ìª½ ê°„ê²© í™•ë³´ */
  padding: 10px;
  display: flex;
  flex-wrap: nowrap;
  gap: 20px;
  overflow-x: auto;
  justify-content: flex-start;
}

.result-card {
  margin-top: 10px;
}
#videoTable {
  display: block !important;
  width: 100%;
  overflow-x: auto;
  margin-top: 20px;
}

#videoTable table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.8rem;
  color: #ffffff;
}

#videoTable th, 
#videoTable td {
  padding: 6px 8px;
  border: 1px solid #333;
  text-align: center;
}

#videoTable th {
  background-color: #333;
  color: #ffa500;
}
/* ë²„íŠ¼ ì…ì²´ íš¨ê³¼ ì œê±° */
button {
  box-shadow: none !important;
  border: none !important;
}

/* ìˆ˜ì‹ í°íŠ¸ í¬ê¸° ì¡°ì • */
.equation {
  font-size: 0.8rem; /* í°íŠ¸ í¬ê¸° ì¤„ì„ */
}

/* Pê°’ ìˆ˜ì¹˜ ìƒ‰ìƒ ìˆ˜ì • */
.metric span.value {
  color: #ffa500 !important; /* íšŒìƒ‰ì„ ì£¼í™©ìƒ‰ìœ¼ë¡œ í†µì¼ */
}

/* About, Download ë²„íŠ¼ ì…ì²´ íš¨ê³¼ ì œê±° */
button, .about-btn {
  background-color: #333333 !important;
  box-shadow: none !important;
}
  /* Analysis ë²„íŠ¼ í°íŠ¸ ìƒ‰ìƒ ë³€ê²½ (í°ìƒ‰ìœ¼ë¡œ) */
.input-area button {
  color: #ffffff !important;
}

/* About VIBE INDEX ë²„íŠ¼ í°íŠ¸ í¬ê¸° í•œ ë‹¨ê³„ ë‚®ì¶”ê¸° */
button[onclick="toggleVibeInfo()"] {
  font-size: 0.7rem !important;
}
  /* About VIBE INDEX ë²„íŠ¼ ì—¬ë°± ë° ìƒ‰ìƒ ì¡°ì • */
button[onclick="toggleVibeInfo()"] {
  padding: 10px 20px !important; /* ìƒí•˜ì¢Œìš° ì—¬ë°± ì¶”ê°€ */
  background-color: #222222 !important; /* ë” ì§„í•œ ë°°ê²½ìƒ‰ */
  color: #ffffff !important; /* í°íŠ¸ ìƒ‰ìƒ í°ìƒ‰ìœ¼ë¡œ ëª…í™•íˆ */
  border-radius: 8px !important; /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
}
</style>
</head>
<body>
  <div style="position: fixed; top: 10px; right: 10px; z-index: 1000;">
  <button onclick="downloadFullExcel()" style="padding:6px 12px; background-color:#333333; color:#FFFFFF; border-radius:8px; font-size:0.8rem;">Download Excel</button>
  <button onclick="downloadPDF()" style="padding:6px 12px; background-color:#333333; color:#FFFFFF; border-radius:8px; font-size:0.8rem;">Download PDF</button>
</div>
  <div class="container">
    <h1>YouTube VIBE Index Analyzer</h1>
<div style="text-align:center; margin-bottom:20px;">
    <div class="tabs">
      <div class="tab active" onclick="switchTab('single')">Single Channel</div>
      <div class="tab" onclick="switchTab('compare')">Multi Channel</div>
    </div>

    <div id="single" class="tab-content">
      <div class="input-area">
        <input type="text" id="singleChannelUrl" placeholder="ì±„ë„ URL ì…ë ¥" />
        <button onclick="analyzeSingleChannel()">Analysis</button>
      </div>

<div class="mode-selector">
  <label><input type="radio" name="mode" value="steady" checked> Steady VIBE</label>
  <label><input type="radio" name="mode" value="trendy"> Trendy VIBE</label>
</div>

      <div id="singleResult"></div>
      <div id="videoTable"></div>
    </div>

    <div id="compare" class="tab-content" style="display: none;">
      <div class="input-area">
        <div class="multi-input-container">
          <input type="text" id="channelUrl1" placeholder="ì±„ë„ URL 1" />
          <input type="text" id="channelUrl2" placeholder="ì±„ë„ URL 2" />
          <input type="text" id="channelUrl3" placeholder="ì±„ë„ URL 3 (ì„ íƒ)" />
          <button onclick="compareChannels()">Compare</button>
        </div>
      </div>

      <div class="mode-selector">
        <label><input type="radio" name="mode" value="steady" checked> Steady VIBE</label>
        <label><input type="radio" name="mode" value="trendy"> Trendy VIBE</label>
      </div>

      <div id="compareResult"></div>
    </div>

    <div class="error" id="errorMsg"></div>
  </div>
  <div style="text-align:center; padding: 20px; margin-top:30px;">
<button onclick="toggleVibeInfo()" style="padding:6px 15px; background-color:#333333; color:#FFFFFF; border-radius:8px; font-size:0.8rem;">
  About VIBE INDEX
</button>

  <div id="vibeInfo" style="display:none; margin-top:20px; background-color:#1e1e1e; padding:20px; border-radius:12px; text-align:left;">
    <h2 style="color: #ffa500; text-align:center;">YouTube VIBE INDEX ì†Œê°œ</h2>

    <h3 style="color: #ffa500;">1. VIBE INDEX ê°œìš” ë° ì‚°ì‹</h3>
    <p>VIBE INDEXëŠ” ìœ íŠœë¸Œ ì±„ë„ì˜ ì½˜í…ì¸  ì„±ê³¼ì™€ ì‹œì²­ì ë°˜ì‘ì„ ê°ê´€ì ì´ê³  íš¨ìœ¨ì ìœ¼ë¡œ í‰ê°€í•˜ê¸° ìœ„í•œ ì¢…í•© ì§€í‘œì…ë‹ˆë‹¤.</p>
    <p><strong>ì‚°ì‹:</strong><br>
      VIBE INDEX = (Eì •ê·œí™” Ã— ê°€ì¤‘ì¹˜E) + (Vì •ê·œí™” Ã— ê°€ì¤‘ì¹˜V) + (U Ã— ê°€ì¤‘ì¹˜U) + (P Ã— ê°€ì¤‘ì¹˜P)</p>
    <ul>
      <li><strong>Steady ê°€ì¤‘ì¹˜:</strong> E:40%, V:40%, U:7.5%, P:12.5%</li>
      <li><strong>Trendy ê°€ì¤‘ì¹˜:</strong> E:50%, V:30%, U:7.5%, P:12.5%</li>
    </ul>
    <p><strong>ì •ê·œí™” ê¸°ì¤€:</strong> E=7%, V=0.9</p>

    <h3 style="color: #ffa500;">2. ê°œë°œ ëª©ì ê³¼ ë°©í–¥ì„±</h3>
    <ul>
      <li>ê°ê´€ì ì´ê³  ê· í˜• ìˆëŠ” ì„±ê³¼ í‰ê°€</li>
      <li>ì‹¤ì œ ì±„ë„ ìš´ì˜ íš¨ìœ¨ì„± ì¦ëŒ€</li>
      <li>ì§ê´€ì ì´ê³  ì‹ ë¢° ê°€ëŠ¥í•œ ì§€í‘œ ì œê³µ</li>
    </ul>

    <h3 style="color: #ffa500;">3. ì„¸ë¶€ ì§€í‘œ ì„¤ëª… (ë³´ì • ê¸°ì¤€ í¬í•¨)</h3>
<ul>
  <li><strong>E (ì°¸ì—¬ìœ¨, Engagement Rate):</strong> (ì¢‹ì•„ìš” + ëŒ“ê¸€) / ì¡°íšŒìˆ˜ Ã— 100 (%)</li>
  
  <li><strong>V (ì¡°íšŒìˆ˜ ì¼ê´€ì„±, Viewership Consistency):</strong>
    1 - (í‘œì¤€í¸ì°¨ / í‰ê·  ì¡°íšŒìˆ˜)<br/>
    <strong style="color:#ffa500;">â€» ì˜ìƒ ìˆ˜ ë³´ì • ê¸°ì¤€ (ìµœê·¼ 60ì¼ê°„)</strong>
    <ul>
      <li>ìµœê·¼ 60ì¼ê°„ ì˜ìƒ ìˆ˜ê°€ 10ê°œ ì´ìƒì¼ ë•Œ â†’ ì •ìƒ Vê°’ 100% ë°˜ì˜</li>
      <li>ìµœê·¼ 60ì¼ê°„ ì˜ìƒ ìˆ˜ê°€ 2~9ê°œì¼ ë•Œ â†’ (ì˜ìƒ ìˆ˜ Ã· 10) ë¹„ìœ¨ë¡œ Vê°’ ì¡°ì • ë°˜ì˜<br/>
        <small style="color:#AAAAAA;">(ì˜ˆ: ì˜ìƒ 5ê°œ â†’ ì •ìƒ Vê°’ì˜ 50% ë°˜ì˜)</small></li>
      <li>ìµœê·¼ 60ì¼ê°„ ì˜ìƒ ìˆ˜ê°€ 1ê°œ ì´í•˜ì¼ ë•Œ â†’ ì‹ ë¢°ì„± ë¶€ì¡±ìœ¼ë¡œ Vê°’ì„ 0ìœ¼ë¡œ ì²˜ë¦¬</li>
    </ul>
  </li>
  
  <li><strong>U (ì—…ë¡œë“œ ë¹ˆë„, Upload Frequency):</strong>
    ìµœê·¼ 60ì¼ ì—…ë¡œë“œ ìˆ˜ Ã· 60 Ã— 100 (%)<br/>
    <strong style="color:#ffa500;">â€» ìµœëŒ€ê°’: 100%</strong> (60ì¼ ë™ì•ˆ ë§¤ì¼ ì—…ë¡œë“œ ì‹œ)</li>
  
  <li><strong>P (ê¸ì • ëŒ“ê¸€ ë¹„ìœ¨, Positive Comment Rate):</strong>
    ê¸ì • ëŒ“ê¸€ ìˆ˜ Ã· ì´ ëŒ“ê¸€ ìˆ˜ Ã— 100 (%)<br/>
    <strong style="color:#ffa500;">â€» ëŒ“ê¸€ ë¹„ê³µê°œ ë˜ëŠ” ìˆ˜ì§‘ ë¶ˆê°€ ì‹œ: 0ì  ì²˜ë¦¬</strong></li>
</ul>

    <h3 style="color: #ffa500;">4. ë²¤ì¹˜ë§ˆí¬ ìš”ì•½</h3>
    <table style="width:100%; margin-top:10px; border-collapse:collapse;">
      <thead>
        <tr>
          <th style="border:1px solid #333; background-color:#333; color:#ffa500;">ì§€í‘œ</th>
          <th style="border:1px solid #333; background-color:#333; color:#ffa500;">ë²¤ì¹˜ë§ˆí¬ ê¸°ì¤€</th>
        </tr>
      </thead>
      <tbody>
        <tr><td style="border:1px solid #333; text-align:center;">E</td><td style="border:1px solid #333; text-align:center;">7%</td></tr>
        <tr><td style="border:1px solid #333; text-align:center;">V</td><td style="border:1px solid #333; text-align:center;">0.9</td></tr>
        <tr><td style="border:1px solid #333; text-align:center;">U</td><td style="border:1px solid #333; text-align:center;">60ì¼ ë§¤ì¼ ì—…ë¡œë“œ=100%</td></tr>
        <tr><td style="border:1px solid #333; text-align:center;">P</td><td style="border:1px solid #333; text-align:center;">100%</td></tr>
      </tbody>
    </table>
    <h3 style="color: #ffa500;">5. ì´ ì¡°íšŒìˆ˜ ê¸°ë°˜ ê°€ì¤‘ì¹˜ ì„¤ëª…</h3>
<p>ì±„ë„ì˜ ì´ ì¡°íšŒìˆ˜ê°€ ì¼ì • ê¸°ì¤€ì„ ì´ˆê³¼í•˜ë©´, VIBE INDEXì— ì¶”ê°€ì ì¸ ê°€ì¤‘ì¹˜ê°€ ì ìš©ë©ë‹ˆë‹¤. ì´ëŠ” ì±„ë„ ê·œëª¨ì™€ ì‹¤ì œì ì¸ ì˜í–¥ë ¥ì„ ë” ì •í™•íˆ ë°˜ì˜í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.</p>

<table style="width:100%; margin-top:10px; border-collapse:collapse;">
  <thead>
    <tr>
      <th style="border:1px solid #333; background-color:#333; color:#ffa500;">ì´ ì¡°íšŒìˆ˜ ë²”ìœ„</th>
      <th style="border:1px solid #333; background-color:#333; color:#ffa500;">ê°€ì¤‘ì¹˜ (%)</th>
    </tr>
  </thead>
  <tbody>
    <tr><td style="border:1px solid #333; text-align:center;">1,000 ì´í•˜</td><td style="border:1px solid #333; text-align:center;">70%</td></tr>
    <tr><td style="border:1px solid #333; text-align:center;">1,001 ~ 10,000</td><td style="border:1px solid #333; text-align:center;">80%</td></tr>
    <tr><td style="border:1px solid #333; text-align:center;">10,001 ~ 100,000</td><td style="border:1px solid #333; text-align:center;">90%</td></tr>
    <tr><td style="border:1px solid #333; text-align:center;">100,001 ~ 500,000</td><td style="border:1px solid #333; text-align:center;">100%</td></tr>
    <tr><td style="border:1px solid #333; text-align:center;">500,001 ~ 1,000,000</td><td style="border:1px solid #333; text-align:center;">105%</td></tr>
    <tr><td style="border:1px solid #333; text-align:center;">1,000,001 ~ 5,000,000</td><td style="border:1px solid #333; text-align:center;">110%</td></tr>
    <tr><td style="border:1px solid #333; text-align:center;">5,000,001 ~ 10,000,000</td><td style="border:1px solid #333; text-align:center;">115%</td></tr>
    <tr><td style="border:1px solid #333; text-align:center;">10,000,001 ì´ìƒ</td><td style="border:1px solid #333; text-align:center;">120%</td></tr>
  </tbody>
</table>
  </div>
</div>
<script>

const API_KEY = "AIzaSyCR0CZsIG0Ucl1Jk6HDXD44peoQITtDnSM";
const url = "AIzaSyCR0CZsIG0Ucl1Jk6HDXD44peoQITtDnSM";
//const value = data?.[0]?.property;

function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
  document.getElementById(tabName).style.display = 'block';
  document.querySelectorAll('.tab').forEach(tab => {
    if (tab.textContent.includes(tabName === 'single' ? 'Single' : 'Multi')) tab.classList.add('active');
  });

  // ë©€í‹° íƒ­ì—ì„œë„ Steady ê¸°ë³¸ ì„ íƒ
  if (tabName === 'compare') {
    document.querySelector('#compare .mode-selector input[value="steady"]').checked = true;
  }
}

function showError(msg) {
  document.getElementById('errorMsg').textContent = msg;
}

// function extractChannelId(url) {
//  const match = url.match(/(?:channel\/|\?id=|@)([\w-]+)/);
//  return match ? match[1] : null;
// } 


// 4.10ì¶”ê°€ ì‹œì‘


// @handle â†’ channel ID ë³€í™˜
async function convertHandleToChannelId(handle, apiKey) {
  const apiUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=channel&q=${encodeURIComponent(
    "@" + handle
  )}&key=${API_KEY}`;

  try {
    const response = await fetch(apiUrl);
    const data = await response.json();

    if (data.items && data.items.length > 0) {
      return data.items[0].id.channelId;
    } else {
      
      console.error("Handleì— í•´ë‹¹í•˜ëŠ” ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return null;
    }
  } catch (error) {
    console.error("API ìš”ì²­ ì‹¤íŒ¨:", error);
    return null;
  }
}

// /user/username â†’ channel ID ë³€í™˜
async function convertUsernameToChannelId(username, apiKey) {
  const apiUrl = `https://www.googleapis.com/youtube/v3/channels?part=id&forUsername=${username}&key=${API_KEY}`;

  try {
    const response = await fetch(apiUrl);
    const data = await response.json();

    if (data.items && data.items.length > 0) {
      return data.items[0].id;
    } else {
      console.error("Usernameì— í•´ë‹¹í•˜ëŠ” ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return null;
    }
  } catch (error) {
    console.error("API ìš”ì²­ ì‹¤íŒ¨:", error);
    return null;
  }
}

async function extractChannelId(url) {
  let channelId = null;
  const channelIdRegex = /\/channel\/([a-zA-Z0-9_-]+)/;
  const userRegex = /\/user\/([a-zA-Z0-9_-]+)/;
  const handleRegex = /\/@([a-zA-Z0-9_-]+)/;

  if (channelIdRegex.test(url)) {
    channelId = url.match(channelIdRegex)[1];
  } else if (userRegex.test(url)) {
    const username = url.match(userRegex)[1];
    channelId = await convertUsernameToChannelId(username, API_KEY);
  } else if (handleRegex.test(url)) {
    const handle = url.match(handleRegex)[1];
    channelId = await convertHandleToChannelId(handle, API_KEY);
  }
  return channelId;
}

// 4.10 ì¶”ê°€ë¶„ ë


function getModeWeights() {
  const mode = document.querySelector('input[name="mode"]:checked').value;
  return mode === 'trendy' ? { e: 0.6, v: 0.3, u: 0.1 } : { e: 0.5, v: 0.4, u: 0.1 };
}

  const chRes = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${channelId}&key=${API_KEY}`);
  const chData = await chRes.json();
  const ch = chData.items[0];

  let nextPageToken = "";
  let allVideos = [];
  do {
    const res = await fetch(`https://www.googleapis.com/youtube/v3/search?key=${API_KEY}&channelId=${channelId}&part=snippet&type=video&order=date&publishedAfter=${new Date(Date.now() - 60*24*60*60*1000).toISOString()}&maxResults=50&pageToken=${nextPageToken}`);
    const json = await res.json();
    allVideos.push(...json.items);
    nextPageToken = json.nextPageToken || "";
  } while (nextPageToken && allVideos.length < 150);

  const videoIds = allVideos.map(v => v.id.videoId).filter(Boolean);
  const stats = [];
  for (let i = 0; i < videoIds.length; i += 50) {
    const batch = videoIds.slice(i, i + 50).join(",");
    const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=statistics,snippet&id=${batch}&key=${API_KEY}`);
    const json = await res.json();
    stats.push(...json.items);
  }

  const views = stats.map(v => +v.statistics.viewCount || 0);
  const likes = stats.map(v => +v.statistics.likeCount || 0);
  const comments = stats.map(v => +v.statistics.commentCount || 0);
  const sum = arr => arr.reduce((a,b)=>a+b,0);
  const avg = views.length ? sum(views) / views.length : 0;
  const std = Math.sqrt(views.map(v => (v - avg) ** 2).reduce((a,b)=>a+b,0) / views.length);
  const E = ((sum(likes) + sum(comments)) / sum(views)) * 100;

  let V = Math.max(1 - (std / avg), 0);
  V = adjustV(V, views.length);  // ğŸš¨ Vì§€í‘œ ë³´ì • í•¨ìˆ˜ ëª…í™•íˆ ì ìš©ë¨

  const U = stats.length >= 60 ? 100 : (stats.length / 60) * 100;
  const w = getModeWeights();
  const VIBE = E * w.e + V * 100 * w.v + U * w.u;

  return {
    name: ch.snippet.title,
    thumbnail: ch.snippet.thumbnails.default.url,
    subs: Number(ch.statistics.subscriberCount).toLocaleString() + 'ëª…',
    created: ch.snippet.publishedAt.split('T')[0],
    uploadsTotal: Number(ch.statistics.videoCount).toLocaleString() + 'ê°œ',
    totalViews: Number(ch.statistics.viewCount).toLocaleString(),
    likes: sum(likes).toLocaleString(),
    comments: sum(comments).toLocaleString(),
    views: sum(views).toLocaleString(),
    avgViews: Math.round(avg).toLocaleString(),
    stdViews: Math.round(std).toLocaleString(),
    E: E.toFixed(1),
    V: V.toFixed(2),
    U: U.toFixed(1),
    VIBE: VIBE.toFixed(1),
    videos: stats,
    videoCount60days: stats.length
  };
}


function renderCard(d, P, commentCount, analyzedVideoCount) {
  const totalViews = parseInt(d.views.replace(/,/g, ''));
  const finalVibe = calculateVIBE(d.E, d.V, d.U, P, totalViews);
  const equation = generateEquation(d.E, d.V, d.U, P);

  return `
    <div class="result-card">
      <div class="channel-info">
        <img src="${d.thumbnail}" />
        <div class="channel-details">
          <strong>${d.name}</strong>
          <ul>
            <li>êµ¬ë…ì ìˆ˜: ${d.subs}</li>
            <li>ì±„ë„ ê°œì„¤ì¼: ${d.created}</li>
            <li>ì´ ì—…ë¡œë“œ: ${d.uploadsTotal}</li>
            <li>ì „ì²´ ì¡°íšŒìˆ˜: ${d.totalViews}</li>
          </ul>
        </div>
      </div>

      <div class="metric">
  <span class="label vibe-label">VIBE Index:</span> 
  <span class="value vibe-index">${finalVibe}<small> Point</small></span>
</div>
      <div class="equation">${equation}</div>

      <div class="metric">
        <span class="label">E (engagement rate):</span> 
        <span class="value">${d.E}%</span>
        <div class="sub-details">
          - ì¢‹ì•„ìš”: ${d.likes}<br/>
          - ëŒ“ê¸€ ìˆ˜: ${d.comments}<br/>
          - ì¡°íšŒìˆ˜: ${d.views}
        </div>
      </div>

      <div class="metric">
        <span class="label">V (viewership consistency):</span> 
        <span class="value">${d.V}</span>
        <div class="sub-details">
          - í‰ê·  ì¡°íšŒìˆ˜: ${d.avgViews}<br/>
          - í‘œì¤€í¸ì°¨: ${d.stdViews}
        </div>
      </div>

      <div class="metric">
        <span class="label">U (upload frequency):</span> 
        <span class="value">${d.U}%</span>
        <div class="sub-details">
          - ìµœê·¼ 60ì¼ ì—…ë¡œë“œ ìˆ˜: ${d.videoCount60days}ê°œ
        </div>
      </div>

      ${P ? `
        <div class="metric">
  <span class="label">P (Positive Comment Rate):</span> 
  <span class="value">${P}%</span>
  <div class="sub-details">
    - ë¶„ì„ ëŒ“ê¸€ ìˆ˜: ${commentCount > 0 ? commentCount + 'ê°œ' : 'ëŒ“ê¸€ ë¹„ê³µê°œ'}<br/>
    - ë¶„ì„ ì˜ìƒ ìˆ˜: ${analyzedVideoCount > 0 ? analyzedVideoCount + 'ê°œ' : 'ëŒ“ê¸€ ë¹„ê³µê°œ'}
  </div>
</div>
        </div>` : ''}
    </div>`;
}

async function analyzeSingleChannel() {
  const url = document.getElementById('singleChannelUrl').value;
  const id = await extractChannelId(url);
  if (!id) return showError('ì±„ë„ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

  const d = await fetchChannelData(id);

  let P = null;
  let commentCount = 0;
  let analyzedVideoCount = 0;

  const recentVideos = await fetchRecentVideos(id, 50);

  let comments = [];
  analyzedVideoCount = 0;
  for (let videoId of recentVideos) {
    if (comments.length >= 100) break;

    const prevCommentCount = comments.length;
    comments = await fetchComments(videoId, comments, 100 - comments.length);

    if (comments.length > prevCommentCount) {
      analyzedVideoCount++;
    }
  }
  commentCount = comments.length;

  if (commentCount > 0) {
    P = await analyzeSentiment(comments);
  } else {
    P = 0; // ğŸ”´ ëŒ“ê¸€ì´ ì—†ê±°ë‚˜ ë¹„ê³µê°œì¼ ë•Œ Pê°’ ëª…í™•íˆ 0ì  ì²˜ë¦¬
  }

  document.getElementById('singleResult').innerHTML = renderCard(d, P, commentCount, analyzedVideoCount);

  const videoTableHTML = renderVideoTable(d.videos);
  document.getElementById('videoTable').innerHTML = videoTableHTML;

  document.getElementById('videoTable').scrollIntoView({ behavior: 'smooth' });
}


async function compareChannels() {
  const urls = [
    document.getElementById('channelUrl1').value,
    document.getElementById('channelUrl2').value,
    document.getElementById('channelUrl3').value
  ].filter(Boolean);

  const result = document.getElementById('compareResult');
  result.innerHTML = '';

  for (const url of urls) {
    const id = await extractChannelId(url);
    if (!id) {
      showError(`ì±„ë„ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${url}`);
      continue;
    }

    const d = await fetchChannelData(id);

let P = null;
let commentCount = 0;
let analyzedVideoCount = 0;

const recentVideos = await fetchRecentVideos(id, 50);

let comments = [];
analyzedVideoCount = 0;

for (let videoId of recentVideos) {
  if (comments.length >= 100) break;

  const prevCommentCount = comments.length;
  comments = await fetchComments(videoId, comments, 100 - comments.length);

  if (comments.length > prevCommentCount) analyzedVideoCount++;
}

commentCount = comments.length;

if (commentCount > 0) {
  P = await analyzeSentiment(comments);
} else {
  P = 0;  // ğŸ”´ ëª…í™•íˆ 0ì ìœ¼ë¡œ ì²˜ë¦¬ (ë¹„ê³µê°œì¼ ë•Œ)
}


    result.innerHTML += renderCard(d, P, commentCount, analyzedVideoCount);
  }
}

// Steady VIBE ê¸°ë³¸ ì„ íƒ í‘œì‹œ (ì‹œê°ì ìœ¼ë¡œë„)
window.onload = function () {
  document.querySelector('input[name="mode"][value="steady"]').checked = true;
};

//
function calculateVIBE(E, V, U, P, totalViews) {
  const mode = document.querySelector('input[name="mode"]:checked').value;
  const E_benchmark = 7;
  const V_benchmark = 0.9;

  const E_normalized = (E / E_benchmark) * 100;
  const V_normalized = (V / V_benchmark) * 100;

  let weights;
  if (mode === 'steady') {
    weights = { e: 0.40, v: 0.40, u: 0.075, p: 0.125 };
  } else {
    weights = { e: 0.50, v: 0.30, u: 0.075, p: 0.125 };
  }

  let vibeIndex = (E_normalized * weights.e) 
                + (V_normalized * weights.v) 
                + (U * weights.u) 
                + (P * weights.p);

  const viewWeight = getViewCountWeight(totalViews);
  vibeIndex *= viewWeight;

  return vibeIndex.toFixed(1);
}

// ì´ ì¡°íšŒìˆ˜ ê¸°ë°˜ ê°€ì¤‘ì¹˜ ê³„ì‚° í•¨ìˆ˜ (calculateVIBE ë°”ë¡œ ìœ„ ë˜ëŠ” ì•„ë˜ì— ì¶”ê°€)
function getViewCountWeight(totalViews) {
  if (totalViews <= 1000) return 0.7;           // 70%
  else if (totalViews <= 10000) return 0.8;     // 80%
  else if (totalViews <= 100000) return 0.9;    // 90%
  else if (totalViews <= 500000) return 1.0;    // 100%
  else if (totalViews <= 1000000) return 1.05;  // 105%
  else if (totalViews <= 5000000) return 1.1;   // 110%
  else if (totalViews <= 10000000) return 1.15; // 115%
  else return 1.2;                              // 120%
}


function generateEquation(E, V, U, P) {
  return `= E(${E}%) + V(${V}) + U(${U}%) + P(${P}%)`;
}

// ğŸš© ì¶”ê°€ë  3ê°€ì§€ í•¨ìˆ˜ë“¤
async function fetchRecentVideos(channelId, maxVideos = 50) {
  let videos = [];
  let nextPageToken = "";
  do {
    const res = await fetch(`https://www.googleapis.com/youtube/v3/search?key=${API_KEY}&channelId=${channelId}&part=id&type=video&order=date&maxResults=${Math.min(50, maxVideos - videos.length)}&pageToken=${nextPageToken}`);
    const data = await res.json();
    videos.push(...data.items.map(item => item.id.videoId));
    nextPageToken = data.nextPageToken || "";
  } while (nextPageToken && videos.length < maxVideos);

  return videos;
}

async function fetchComments(videoId, collectedComments, maxComments) {
  try {
    const res = await fetch(`https://www.googleapis.com/youtube/v3/commentThreads?part=snippet&videoId=${videoId}&maxResults=${Math.min(maxComments,100)}&key=${API_KEY}`);
    const data = await res.json();

    if (!data.items) {
      console.warn("ëŒ“ê¸€ ì ‘ê·¼ ì œí•œìœ¼ë¡œ ì¸í•´ ëŒ“ê¸€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Video ID:", videoId);
      return collectedComments;
    }

    return collectedComments.concat(data.items.map(item => item.snippet.topLevelComment.snippet.textOriginal));
  } catch (error) {
    console.error("ëŒ“ê¸€ API í˜¸ì¶œ ì‹¤íŒ¨:", error);
    return collectedComments; // ê¸°ì¡´ ëŒ“ê¸€ë§Œ ë°˜í™˜
  }
}

const NLP_API_KEY = "AIzaSyCR0CZsIG0Ucl1Jk6HDXD44peoQITtDnSM";  // NLPìš© APIí‚¤ ì…ë ¥

async function analyzeSentiment(comments) {
  const doc = comments.join(". ");
  const res = await fetch(`https://language.googleapis.com/v1/documents:analyzeSentiment?key=${NLP_API_KEY}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ document: { type: "PLAIN_TEXT", content: doc }, encodingType: "UTF8" })
  });
  const sentimentData = await res.json();
  const positiveComments = sentimentData.sentences.filter(s => s.sentiment.score >= 0).length;
  return ((positiveComments / sentimentData.sentences.length) * 100).toFixed(1);
}
function toggleVibeInfo() {
  const vibeInfo = document.getElementById('vibeInfo');
  vibeInfo.style.display = (vibeInfo.style.display === 'none' || vibeInfo.style.display === '') ? 'block' : 'none';
}  
  async function downloadFullExcel() {
  const url = document.getElementById('singleChannelUrl').value;
  const id = await extractChannelId(url);
  if (!id) {
    alert("ì±„ë„ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const d = await fetchChannelData(id);
  let P = null;
  let commentCount = 0;
  let analyzedVideoCount = 0;

  const recentVideos = await fetchRecentVideos(id, 50);
  let comments = [];
  analyzedVideoCount = 0;

  for (let videoId of recentVideos) {
    if (comments.length >= 100) break;

    const prevCommentCount = comments.length;
    comments = await fetchComments(videoId, comments, 100 - comments.length);
    if (comments.length > prevCommentCount) analyzedVideoCount++;
  }

  commentCount = comments.length;
  if (commentCount > 0) {
    P = await analyzeSentiment(comments);
  }

  const wb = XLSX.utils.book_new();

  const channelInfo = [
    ["ì±„ë„ëª…", d.name],
    ["êµ¬ë…ì ìˆ˜", d.subs],
    ["ì±„ë„ ê°œì„¤ì¼", d.created],
    ["ì´ ì—…ë¡œë“œ ìˆ˜", d.uploadsTotal],
    ["ì „ì²´ ì¡°íšŒìˆ˜", d.totalViews],
    ["ë°ì´í„° ìˆ˜ì§‘ì¼", new Date().toLocaleDateString()]
  ];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(channelInfo), "ì±„ë„ ê¸°ë³¸ ì •ë³´");

  const metrics = [
    ["ì§€í‘œ", "ê°’"],
    ["VIBE Index", calculateVIBE(d.E, d.V, d.U, P, parseInt(d.views.replace(/,/g, '')))],
    ["E (ì°¸ì—¬ìœ¨ %)", d.E],
    ["ì¢‹ì•„ìš” ìˆ˜", d.likes],
    ["ëŒ“ê¸€ ìˆ˜", d.comments],
    ["ì¡°íšŒìˆ˜", d.views],
    ["V (ì¡°íšŒìˆ˜ ì¼ê´€ì„±)", d.V],
    ["í‰ê·  ì¡°íšŒìˆ˜", d.avgViews],
    ["ì¡°íšŒìˆ˜ í‘œì¤€í¸ì°¨", d.stdViews],
    ["U (ì—…ë¡œë“œ ë¹ˆë„ %)", d.U],
    ["ìµœê·¼ 60ì¼ ì—…ë¡œë“œ ìˆ˜", d.videoCount60days],
    ["P (ê¸ì • ëŒ“ê¸€ ë¹„ìœ¨ %)", P ? P : "N/A"],
    ["ëŒ“ê¸€ ë¶„ì„ ëŒ€ìƒ ìˆ˜", commentCount],
    ["ëŒ“ê¸€ ë¶„ì„ ì˜ìƒ ìˆ˜", analyzedVideoCount]
  ];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(metrics), "ì„¸ë¶€ ì§€í‘œ");

  const videoData = d.videos.map(v => [
    v.snippet.title,
    v.snippet.publishedAt.slice(0, 10),
    (+v.statistics.viewCount || 0),
    (+v.statistics.likeCount || 0),
    (+v.statistics.commentCount || 0)
  ]);
  videoData.unshift(["ì œëª©", "ì—…ë¡œë“œ ë‚ ì§œ", "ì¡°íšŒìˆ˜", "ì¢‹ì•„ìš” ìˆ˜", "ëŒ“ê¸€ ìˆ˜"]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(videoData), "ìµœê·¼ ì˜ìƒ 50ê°œ");

  XLSX.writeFile(wb, `${d.name}_full_analysis_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ ì¶”ê°€
function downloadPDF() {
  const element = document.body;
  const opt = {
    margin: 0.5,
    filename: `YouTube_VIBE_Index_${new Date().toISOString().slice(0,10)}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().set(opt).from(element).save();
}
  // ì˜ìƒ ìˆ˜ ë³´ì • í•¨ìˆ˜ (ì¤‘ë³µ ì œê±°, ìµœì¢… ë²„ì „)
function adjustV(V, videoCount) {
  if (videoCount <= 1) return 0;
  if (videoCount >= 10) return V;
  return +(V * (videoCount / 10)).toFixed(2);
}

// ì±„ë„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì¤‘ë³µ ì œê±°ëœ ìµœì¢… ë²„ì „)
async function fetchChannelData(channelId) {
  const chRes = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${channelId}&key=${API_KEY}`);
  const chData = await chRes.json();
  const ch = chData.items[0];

  let nextPageToken = "";
  let allVideos = [];
  do {
    const res = await fetch(`https://www.googleapis.com/youtube/v3/search?key=${API_KEY}&channelId=${channelId}&part=snippet&type=video&order=date&publishedAfter=${new Date(Date.now() - 60*24*60*60*1000).toISOString()}&maxResults=50&pageToken=${nextPageToken}`);
    const json = await res.json();
    allVideos.push(...json.items);
    nextPageToken = json.nextPageToken || "";
  } while (nextPageToken && allVideos.length < 150);

  const videoIds = allVideos.map(v => v.id.videoId).filter(Boolean);
  const stats = [];
  for (let i = 0; i < videoIds.length; i += 50) {
    const batch = videoIds.slice(i, i + 50).join(",");
    const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=statistics,snippet&id=${batch}&key=${API_KEY}`);
    const json = await res.json();
    stats.push(...json.items);
  }

  const views = stats.map(v => +v.statistics.viewCount || 0);
  const likes = stats.map(v => +v.statistics.likeCount || 0);
  const comments = stats.map(v => +v.statistics.commentCount || 0);
  const sum = arr => arr.reduce((a,b)=>a+b,0);
  const avg = views.length ? sum(views) / views.length : 0;
  const std = Math.sqrt(views.map(v => (v - avg) ** 2).reduce((a,b)=>a+b,0) / views.length);
  const E = ((sum(likes) + sum(comments)) / sum(views)) * 100;

  let V = Math.max(1 - (std / avg), 0);
  V = adjustV(V, views.length);  // ğŸš¨ V ì§€í‘œ ë³´ì • í•¨ìˆ˜ ì ìš©ë¨

  const U = stats.length >= 60 ? 100 : (stats.length / 60) * 100;
  const w = getModeWeights();
  const VIBE = E * w.e + V * 100 * w.v + U * w.u;

  return {
    name: ch.snippet.title,
    thumbnail: ch.snippet.thumbnails.default.url,
    subs: Number(ch.statistics.subscriberCount).toLocaleString() + 'ëª…',
    created: ch.snippet.publishedAt.split('T')[0],
    uploadsTotal: Number(ch.statistics.videoCount).toLocaleString() + 'ê°œ',
    totalViews: Number(ch.statistics.viewCount).toLocaleString(),
    likes: sum(likes).toLocaleString(),
    comments: sum(comments).toLocaleString(),
    views: sum(views).toLocaleString(),
    avgViews: Math.round(avg).toLocaleString(),
    stdViews: Math.round(std).toLocaleString(),
    E: E.toFixed(1),
    V: V.toFixed(2),
    U: U.toFixed(1),
    VIBE: VIBE.toFixed(1),
    videos: stats,
    videoCount60days: stats.length
  };
}

function renderVideoTable(videos) {
  let tableHtml = `
    <table>
      <thead>
        <tr>
          <th>No.</th>
          <th>ì˜ìƒ ì œëª©</th>
          <th>ì—…ë¡œë“œ ë‚ ì§œ</th>
          <th>ì¡°íšŒìˆ˜</th>
          <th>ì¢‹ì•„ìš” ìˆ˜</th>
          <th>ëŒ“ê¸€ ìˆ˜</th>
        </tr>
      </thead>
      <tbody>
  `;

  videos.forEach((video, idx) => {
    const title = video.snippet.title;
    const date = video.snippet.publishedAt.slice(0, 10);
    const views = (+video.statistics.viewCount || 0).toLocaleString();
    const likes = (+video.statistics.likeCount || 0).toLocaleString();
    const comments = (+video.statistics.commentCount || 0).toLocaleString();

    tableHtml += `
      <tr>
        <td>${idx + 1}</td>
        <td style="text-align: left; padding-left: 10px;">${title}</td>
        <td>${date}</td>
        <td>${views}</td>
        <td>${likes}</td>
        <td>${comments}</td>
      </tr>
    `;
  });

  tableHtml += '</tbody></table>';

  return tableHtml;
}

</script>
<footer style="padding: 10px 0; border-top: 1px solid #333; font-size: 0.8rem; color: #888; position: fixed; bottom: 0; left: 0; width: 100%; background-color: #000000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000;">
  <img src="https://github.com/dookie777/vibe-index/blob/main/Logo_white.png?raw=true"
       alt="The Eroom Sports Logo"
       style="width: 100px; height: auto; margin-bottom: 5px;">
  <div>Â© 2025 The Eroom Sports. All rights reserved.</div>
</footer>
</body>
</html>
